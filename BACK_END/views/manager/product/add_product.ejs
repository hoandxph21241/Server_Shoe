<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm sản phẩm</title>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.0.1/dist/css/multi-select-tag.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        .main-content {
            margin-left: 30px;
            margin-right: 30px;
        }
        .img-thumbnail {
            width: 100px;
            height: auto;
        }
        .storage-shoe-entry {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <%- include('../../inc/top.ejs') %>
    <div class="main-content">
        <form id="productForm">
            <h1>Thêm sản phẩm</h1>
            <div class="row mb-3">
                <div class="col-12">
                    <img id="productImagePreview" src="https://via.placeholder.com/200x100" class="img-fluid"
                        alt="Product Image">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="thumbnail" class="form-label">Ảnh thumbnail:</label>
                        <input type="file" class="form-control" id="thumbnail" name="thumbnail">
                    </div>
                    <div class="mb-3">
                        <label for="nameShoe" class="form-label">Tên sản phẩm:</label>
                        <input type="text" class="form-control" id="nameShoe" name="name">
                    </div>
                    <div class="mb-3">
                        <label for="importPrice" class="form-label">Giá:</label>
                        <input type="number" class="form-control" id="importPrice" name="importPrice">
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Mô tả:</label>
                        <textarea class="form-control" id="description" rows="3" name="description"></textarea>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="productImage" class="form-label">Ảnh sản phẩm:</label>
                        <input type="file" class="form-control" id="productImage" name="imageShoe" multiple>
                    </div>
                    <div class="mb-3">
                        <label for="brand" class="form-label">Hãng:</label>
                        <select class="form-select" id="brand" name="typerShoeId">
                            <% listTyper.forEach(function(typer) { %>
                                <option value="<%= typer._id %>">
                                    <%= typer.nameType %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    <div id="storageShoeContainer">
                        <!-- Storage Shoe entries will be added here -->
                    </div>
                    <button type="button" id="addStorageShoe" class="btn btn-secondary mb-3">Thêm Storage Shoe</button>
                </div>
            </div>
            <div class="d-flex justify-content-center">
                <button type="button" class="btn me-2" id="cancelButton"
                    style="width: 150px; height: 40px;background-color: #f6f6f6;color: #4340DA;">Cancel</button>
                <button type="button" class="btn text-white" id="saveButton"
                    style="width: 150px; height: 40px;background-color: #4340DA;">Save</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.0.1/dist/js/multi-select-tag.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let storageShoeCount = 0;
            let selectedSizes = {};
            let selectedColors = {};

            function createStorageShoeEntry() {
                storageShoeCount++;
                const entryHtml = `
                    <div class="storage-shoe-entry" id="storageShoe_${storageShoeCount}">
                        <div class="row">
                            <div class="col-md-6">
                                <form class="colorForm">
                                    <label for="color_${storageShoeCount}" class="mb-3">Chọn Màu</label>
                                    <select name="colorShoe_${storageShoeCount}" id="color_${storageShoeCount}" multiple>
                                        <% listColor.forEach(function(color) { %>
                                            <option value="<%= color._id %>"><%= color.textColor %></option>
                                        <% }); %>
                                    </select>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <form class="sizeForm">
                                    <label for="size_${storageShoeCount}" class="mb-3">Chọn Size</label>
                                    <select name="sizeShoe_${storageShoeCount}" id="size_${storageShoeCount}" multiple>
                                        <% listSize.forEach(function(size) { %>
                                            <option value="<%= size.size %>"><%= size.sizeId %></option>
                                        <% }); %>
                                    </select>
                                    <div class="sizeQuantity mt-3" id="sizeQuantity_${storageShoeCount}"></div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('storageShoeContainer').insertAdjacentHTML('beforeend', entryHtml);
                
                // Initialize arrays for this entry
                selectedSizes[storageShoeCount] = [];
                selectedColors[storageShoeCount] = [];

                // Initialize MultiSelectTag for color and size
                new MultiSelectTag(`color_${storageShoeCount}`, {
                    rounded: true,
                    shadow: true,
                    placeholder: 'Search',
                    onChange: function(values) {
                        selectedColors[storageShoeCount] = values.map(v => v.value);
                    }
                });

                new MultiSelectTag(`size_${storageShoeCount}`, {
                    rounded: true,
                    shadow: true,
                    placeholder: 'Search',
                    onChange: function(values) {
                        selectedSizes[storageShoeCount] = values.map(v => v.value);
                        updateQuantityInputs(storageShoeCount);
                    }
                });
            }

            function updateQuantityInputs(entryId) {
                const quantityContainer = document.getElementById(`sizeQuantity_${entryId}`);
                quantityContainer.innerHTML = '';
                selectedSizes[entryId].forEach(size => {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `quantity_${entryId}_${size}`;
                    input.name = `quantity_${entryId}_${size}`;
                    input.placeholder = `Quantity for size ${size}`;
                    input.className = 'form-control mt-2';
                    quantityContainer.appendChild(input);
                });
            }

            document.getElementById('addStorageShoe').addEventListener('click', createStorageShoeEntry);

            // Create the first storage shoe entry when the page loads
            createStorageShoeEntry();

            document.getElementById('saveButton').addEventListener('click', async function () {
                const form = document.getElementById('productForm');
                const formData = new FormData(form);

                // Convert FormData to a plain object for all non-file fields
                const formObject = {};
                formData.forEach((value, key) => {
                    if (key !== 'thumbnail' && key !== 'imageShoe') {
                        if (formObject[key]) {
                            if (Array.isArray(formObject[key])) {
                                formObject[key].push(value);
                            } else {
                                formObject[key] = [formObject[key], value];
                            }
                        } else {
                            formObject[key] = value;
                        }
                    }
                });

                // Tạo một FormData mới để đẩy file thumbnail và imageShoe
                const fileData = new FormData();
                fileData.append('thumbnail', formData.get('thumbnail'));
                const imageShoeFiles = formData.getAll('imageShoe');
                imageShoeFiles.forEach(file => fileData.append('imageShoe', file));

                try {
                    const fileUploadResponse = await fetch('/manager/uploadsFile', {
                        method: 'POST',
                        body: fileData
                    });
                    const fileUploadData = await fileUploadResponse.json();

                    const storageShoeData = [];
                    for (let i = 1; i <= storageShoeCount; i++) {
                        const quantities = {};
                        selectedSizes[i].forEach(size => {
                            const quantityInput = document.getElementById(`quantity_${i}_${size}`);
                            if (quantityInput) {
                                quantities[size] = parseInt(quantityInput.value) || 0;
                            }
                        });

                        storageShoeData.push({
                            colorShoe: selectedColors[i],
                            sizeShoe: selectedSizes[i].map(size => ({
                                size: size,
                                quantity: quantities[size] || 0,
                            }))
                        });
                    }

                    const data = {
                        name: formObject.name,
                        importPrice: parseFloat(formObject.importPrice),
                        description: formObject.description,
                        typerShoeId: formObject.typerShoeId,
                        thumbnail: fileUploadData.thumbnail,
                        imageShoe: fileUploadData.imageShoe,
                        storageShoe: storageShoeData
                    };

                    console.log('Payload Data:', data);

                    // Gửi JSON sau khi đã có dữ liệu hình ảnh
                    const productResponse = await fetch('/manager/addproduct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (productResponse.ok) {
                        alert('Sản phẩm đã được thêm thành công!');
                    } else {
                        throw new Error('Có lỗi xảy ra khi thêm sản phẩm');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi thêm sản phẩm!');
                }
            });
        });
    </script>

    <%- include('../../inc/end.ejs') %>
</body>

</html>